<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foundation | My first accordion</title>
    <link rel="stylesheet" href="css/foundation.css" />
    <script src="js/vendor/custom.modernizr.js"></script>
    <script type="text/javascript">
      var PAYMILL_PUBLIC_KEY = '264783270323a4a3374e4bdcdee9f8d2';
      var VALIDATE_CVC = true;
    </script>
  </head>
  <body>


    <form> 
      <div class="name-field"> 
        <label>Your name <small>required</small></label> 
        <input type="text" required pattern="[a-zA-Z]+"> <small class="error">Name is required and must be a string.</small> 
      </div> 
      <div class="email-field"> 
        <label>Email <small>required</small></label> 
        <input type="email" required> <small class="error">An email address is required.</small> 
      </div> 
      <button type="submit">Submit</button> 
    </form>    

    <div class="section-container accordion large-12 columns" data-section="accordion">
      <section>
        <div class="title" data-section-title>
          <div class="row">
            <a href="#">
              <span class="small-4 large-2 columns">                  
                Warenkorb
              </span>
              <span class="small-4 large-2 columns">
                4 Artikel
              </span>
              <span class="small-2 large-1 columns">
                119,96 &euro;
              </span>
              <span class="small-2 large-7 columns">
                &nbsp;
              </span>
            </a>
          </div>
        </div>

        <div class="content" data-section-content>
          <p>Content of section 1.</p>
        </div>
      </section>
      <section>
        <p class="title" data-section-title><a href="#">Service und Versandkosten</a></p>
        <div class="content" data-section-content>
          <form method="post" action="warenkorb2/" id="caddy-options" name="caddy">
            <input type="hidden" value="1" name="tx_caddy_pi1[updateByCaddy]">
            <div class="row caddy_options">
              <div id="caddy_shipping" class="small-6 large-4 columns">
                <fieldset>
                  <legend>Versand</legend>
                  <label for="tx_caddy_pi1_shipping_1">
                    <input type="radio" checked="checked" value="1" id="tx_caddy_pi1_shipping_1" name="tx_caddy_pi1[shipping]" onchange="this.form.submit()" class="onChangeloadCaddyByAjax">
                    DHL Standard (0 €)
                  </label>
                  <label for="tx_caddy_pi1_shipping_2">
                    <input type="radio" value="2" id="tx_caddy_pi1_shipping_2" name="tx_caddy_pi1[shipping]" onchange="this.form.submit()" class="onChangeloadCaddyByAjax">
                    DHL Express (12 €)
                  </label>
                </fieldset>
              </div>
              <div id="caddy_specials" class="small-6 large-4 columns">
                <fieldset>
                  <legend>Weitere Optionen</legend>
                  <label for="tx_caddy_pi1_specials_1">
                    <input type="checkbox" value="1" id="tx_caddy_pi1_specials_1" name="tx_caddy_pi1[specials][]" onchange="this.form.submit()" class="onChangeloadCaddyByAjax hidden-field"><span class="custom checkbox"></span>
                    Neutrale Verpackung (0 €)
                  </label>
                  <label for="tx_caddy_pi1_specials_2">
                    <input type="checkbox" value="2" id="tx_caddy_pi1_specials_2" name="tx_caddy_pi1[specials][]" onchange="this.form.submit()" class="onChangeloadCaddyByAjax hidden-field"><span class="custom checkbox"></span>
                    Inselzuschlag (13 €)
                  </label>
                </fieldset>
              </div>
              <div class="small-0 large-4 columns">
                &nbsp;
              </div>
            </div>
          </form>
        </div>
      </section>
      <section class="active">
        <p class="title" data-section-title><a href="#">Zahlungsmethode</a></p>
        <div class="content" data-section-content>
          <form id="payment-form" action="payment.php" method="POST">
            <div class="section-container tabs" data-section="tabs">
              <section class="active">
                <p class="title" data-section-title><a id="payment-cc" class="paymenttype" href="#">Legacy credit card</a></p>
                <div class="content" data-section-content>
                  <fieldset>
                    <legend>Legacy credit card</legend>
                    <div class="row">
                      <div class="large-6 columns">                  
                        <label for="card-number">Card number</label>
                        <input id="card-number" class="card-number" type="text" placeholder="**** **** **** ****" maxlength="19">
                      </div>
                      <div class="large-6 columns">                  
                        <label for="card-expiry">Expires</label>
                        <input id="card-expiry" class="card-expiry" type="text" placeholder="MM/YY" maxlength="7">
                      </div>
                    </div>
                    <div class="row">
                      <div class="large-9 columns">                  
                        <label for="card-holdername">Card holder</label>
                        <input id="card-holdername" class="card-holdername" type="text">
                      </div>
                      <div class="large-3 columns">                  
                        <label for="card-cvc"><span class="card-cvc-label">CVC</span><span id="tooltip" title="">?</span></label>
                        <input id="card-cvc" class="card-cvc" type="text" placeholder="CVC" maxlength="4">
                      </div>
                    </div>
                  </fieldset>
                </div>
              </section>
              <section>
                <p class="title" data-section-title><a id="payment-elv" class="paymenttype" href="#">Direct debit</a></p>
                <div class="content" data-section-content>
                  <fieldset>
                    <legend>Direct debit</legend>
                    <div class="row">
                      <div class="large-6 columns">                  
                        <label for="elv-iban">IBAN</label>
                        <input id="elv-iban" class="elv-iban" type="text">
                      </div>
                      <div class="large-6 columns">                  
                        <label for="elv-bic">BIC</label>
                        <input id="elv-bic" class="elv-bic" type="text">
                      </div>
                    </div>
                    <div class="row">
                      <div class="large-12 columns">                  
                        <label for="elv-holdername">Holdername</label>
                        <input id="elv-holdername" class="elv-holdername" type="text">
                      </div>
                    </div>
                  </fieldset>
                </div>
              </section>
            </div>
            <fieldset>
              <legend>Amount</legend>
              <div class="row">
                <div class="large-6 columns">                  
                  <label for="amount">Amount</label>
                  <input id="amount" type="text" value="10.00" name="amount">
                </div>
                <div class="large-6 columns">                  
                  <label for="currency">Currency</label>
                  <input id="currency" type="text" value="EUR" name="currency">
                </div>
              </div>
              <div class="row">
                <div class="payment_errors">&nbsp;</div>
                <div class="large-12 columns">                  
                  <button id="paymill-submit-button" class="submit-button" type="submit">Submit</button>
                </div>
              </div>
            </fieldset>
          </form>
        </div>
      </section>
      <section>
        <p class="title" data-section-title><a href="#">Ihre Bestellung</a></p>
        <div class="content" data-section-content>
          <p>Content of section 4.</p>
        </div>
      </section>
      <section>
        <p class="title" data-section-title><a href="#">Ihre Daten, Widerrufsbelehrung</a></p>
        <div class="content" data-section-content>
          <p>Content of section 5.</p>
        </div>
      </section>
    </div>

    <script src="js/vendor/jquery.js"></script>
    <script type="text/javascript" src="https://bridge.paymill.de/"></script>
    <!--<script src="js/foundation.min.js"></script> -->
    <script src="js/foundation/foundation.js"></script>
    <script src="js/foundation/foundation.abide.js"></script>
    <script src="js/foundation/foundation.section.js"></script>
    <script>
      $(document).foundation();
    </script>
    <script type="text/javascript">
      $.noConflict();

      jQuery(document).ready(function ($) {
        var doc = document;
        var body = $( doc.body );

        $('.card-number').keyup(function() {
          var brand = paymill.cardType($('.card-number').val());
          brand = brand.toLowerCase();
          $(".card-number")[0].className = $(".card-number")[0].className.replace(/paymill-card-number-.*/g, '');
          if (brand !== 'unknown') {
            $('#card-number').addClass("paymill-card-number-" + brand);
          }

          if (brand !== 'maestro') {
            VALIDATE_CVC = true;
          } else {
            VALIDATE_CVC = false;
          }
        });

        $('.card-expiry').keyup(function() {
          if ( /^\d\d$/.test( $('.card-expiry').val() ) ) {
            text = $('.card-expiry').val();
            $('.card-expiry').val(text += "/");
          }
        });


        function PaymillResponseHandler(error, result) {
          if (error) {
            // Zeigt den Fehler überhalb des Formulars an
            $(".payment_errors").text(error.apierror);
            $(".payment_errors").css("display","inline");
          } else {
            $(".payment_errors").css("display","none");
            $(".payment_errors").text("");
            var form = $("#payment-form");
            // Token
            var token = result.token;
            // Token in das Formular einfügen damit es an den Server übergeben wird
            form.append("<input type='hidden' name='paymillToken' value='" + token + "'/>");
            form.get(0).submit();
          }
          $(".submit-button").removeAttr("disabled");
        }

        $("#payment-form").submit(function (event) {
          // Absenden Button deaktivieren um weitere Klicks zu vermeiden
          $('.submit-button').attr("disabled", "disabled");

          paymenttype = $('.paymenttype_active').length ? $('.paymenttype_active').attr( 'id' ) : 'payment-cc';
          switch (paymenttype) {
            case "payment-cc":
              $('.submit-button').attr("disabled", "disabled");
              if (false == paymill.validateHolder($('.card-holdername').val())) {
                $(".payment_errors").text("invalid-card-holdername");
                $(".payment_errors").css("display","inline");
                $(".submit-button").removeAttr("disabled");
                return false;
              }
              if (false == paymill.validateCvc($('.card-cvc').val())) {
                if(VALIDATE_CVC){
                  $(".payment_errors").text("invalid-card-cvc");
                  $(".payment_errors").css("display","inline");
                  $(".submit-button").removeAttr("disabled");
                  return false;
                } else {
                  $('.card-cvc').val("000");
                }
              }
              if (false == paymill.validateCardNumber($('.card-number').val())) {
                $(".payment_errors").text("invalid-card-number");
                $(".payment_errors").css("display","inline");
                $(".submit-button").removeAttr("disabled");
                return false;
              }
              var expiry = $('.card-expiry').val();
              expiry = expiry.split("/");
              if(expiry[1] && (expiry[1].length <= 2)){
                expiry[1] = '20'+expiry[1];
              }
              if (false == paymill.validateExpiry(expiry[0], expiry[1])) {
                $(".payment_errors").text("invalid-card-expiry-date");
                $(".payment_errors").css("display","inline");
                $(".submit-button").removeAttr("disabled");
                return false;
              }
              alert( "DEV: Formular darf an dieser Stelle noch nicht gesendet werden. Daten müssen in Caddy-Session übernommen werden.");
              return false;
              var params = {
                amount_int:     $('.amount').val() * 100,  // E.g. "15" for 0.15 Eur
                currency:       $('.currency').val(),    // ISO 4217 e.g. "EUR"
                number:         $('.card-number').val(),
                exp_month:      expiry[0],
                exp_year:       expiry[1],
                cvc:            $('.card-cvc').val(),
                cardholder:     $('.card-holdername').val()
              };
              break;

            case "payment-elv":
              $('.submit-button').attr("disabled", "disabled");
              if (false == $('.elv-holdername').val()) {
                $(".payment_errors").text("invalid-elv-holdername");
                $(".payment_errors").css("display","inline");
                $(".submit-button").removeAttr("disabled");
                return false;
              }
              if (false == paymill.validateAccountNumber($('.elv-account').val())) {
                $(".payment_errors").text("invalid-elv-accountnumber");
                $(".payment_errors").css("display","inline");
                $(".submit-button").removeAttr("disabled");
                return false;
              }
              if (false == paymill.validateBankCode($('.elv-bankcode').val())) {
                $(".payment_errors").text("invalid-elv-bankcode");
                $(".payment_errors").css("display","inline");
                $(".submit-button").removeAttr("disabled");
                return false;
              }
              alert( "DEV: Formular darf an dieser Stelle noch nicht gesendet werden. Daten müssen in Caddy-Session übernommen werden.");
              return false;
              var params = {
                number:         $('.elv-account').val(),
                bank:           $('.elv-bankcode').val(),
                accountholder:  $('.elv-holdername').val()
              };
              break;
          }

          paymill.createToken(params, PaymillResponseHandler);
          return false;
        });
        // Toggle buttons and forms
        $(".paymenttype").click(function (event) {
          if ($(this).hasClass('paymenttype_active')){
            return false;
          }
          $(".payment_errors").css("display","none");
          if ($(this).attr( 'id' ) == 'payment-cc') {
            $('#payment-elv').removeClass('paymenttype_active');
            $('#payment-cc').addClass('paymenttype_active');
          } else {
            $('#payment-cc').removeClass('paymenttype_active');
            $('#payment-elv').addClass('paymenttype_active');
          }
        });
      });
    </script>
    <script type="text/javascript">
      jQuery( document ).ready( function( $ ) {
        $( "form" ).attr( "data-abide", "data-abide" );
        $( document ).foundation( "abide", "events" ); // 4.x
      });
    </script>
  </body>
</html>